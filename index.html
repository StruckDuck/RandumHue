<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Color Reveal App</title>
  <style>
    :root { --vh: 1vh; }

    html, body {
      margin: 0;
      height: 100%;
      width: 100%;
      overflow: hidden;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background-color: #000;
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
    }

    #app {
      width: 100vw;
      height: calc(var(--vh) * 100);
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      cursor: pointer;
      transition: background-color 1s ease;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      background-color: black;
    }

    #startBtn {
      z-index: 2;
      padding: 16px 24px;
      border: 2px solid rgba(255,255,255,0.9);
      color: #fff;
      background: rgba(0,0,0,0.35);
      font-size: 18px;
      border-radius: 12px;
    }

    /* Secret buttons / visual zones — kept for optional overlay layout, but fully invisible */
    #left, #right {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 50vw;
      height: calc(var(--vh) * 100);
      z-index: 1;
      opacity: 0;              /* fully invisible */
      pointer-events: none;    /* clicks handled on #app */
    }
    #left { left: 0; }
    #right { right: 0; }

    /* Toast */
    #toast {
      position: fixed;
      top: 20px;
      left: 20px;
      background: rgba(0,0,0,0.75);
      color: #fff;
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.35;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.35s ease;
      z-index: 9999;
      white-space: pre-line;
    }
    #toast.show { opacity: 1; }
  </style>
</head>
<body>
  <div id="app" aria-label="Color Reveal App">
    <button id="startBtn" type="button" aria-label="Start routine">Start</button>
    <div id="left" aria-hidden="true"></div>
    <div id="right" aria-hidden="true"></div>
  </div>
  <div id="toast" role="status" aria-live="polite"></div>

  <script>
    // ---------- Mobile 100vh fix ----------
    function setVH() {
      document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
    }
    setVH();
    window.addEventListener('resize', setVH);

    // ---------- Color mapping (1–9). Others -> Pink (warning) ----------
    const TABLE_COLOR_MAP = {
      1: "Black",
      2: "Blue",
      3: "Green",
      4: "Red",
      5: "White",
      6: "Yellow",
      7: "Purple",
      8: "Orange",
      9: "Grey",
    };

    // Input colors (fixed preset sequence) — taps on these screens record bits
    const INPUT_ORDER = ["Black", "Blue", "Green", "Red"]; // display order
    const INPUT_SET = new Set(INPUT_ORDER);

    // Random palette: only working colors (Pink is never random)
    const RANDOM_COLORS = Object.values(TABLE_COLOR_MAP);

    // ---------- State ----------
    let tapIndex = 0;                 // increments with each tap
    let previousColor = null;         // last shown color (string)
    let currentColor = "Black";       // current background color (capitalized)
    let bitsByColor = { Black: null, Blue: null, Green: null, Red: null };
    let decodedColor = null;
    let decodedDecimal = null;

    // ---------- Elements ----------
    const app = document.getElementById('app');
    const startBtn = document.getElementById('startBtn');
    const toast = document.getElementById('toast');

    // ---------- Utilities ----------
    function showColor(color) {
      app.style.backgroundColor = color.toLowerCase();
      previousColor = currentColor;
      currentColor = color;
    }

    function getRandomColor(exclude = []) {
      const hardExclusions = new Set(["Pink", ...exclude]);
      const available = RANDOM_COLORS.filter(c => !hardExclusions.has(c) && c !== previousColor);
      const pool = available.length ? available : RANDOM_COLORS.filter(c => c !== previousColor);
      return pool[Math.floor(Math.random() * pool.length)];
    }

    function reset() {
      tapIndex = 0;
      previousColor = null;
      currentColor = "Black";
      bitsByColor = { Black: null, Blue: null, Green: null, Red: null };
      decodedColor = null;
      decodedDecimal = null;
      showColor(getRandomColor(["Purple", ...INPUT_ORDER])); // warm-up color, never an input color
    }

    function allBitsCaptured() {
      return INPUT_ORDER.every(c => bitsByColor[c] !== null);
    }

    function computeDecode() {
      const orderedBits = INPUT_ORDER.map(c => bitsByColor[c]); // [Black, Blue, Green, Red]
      const reversedBits = orderedBits.slice().reverse();       // Red..Black
      const binStr = reversedBits.join('');
      const decimal = parseInt(binStr, 2);
      decodedDecimal = decimal;
      decodedColor = TABLE_COLOR_MAP[decimal] || "Pink";

      showToast(
        `Bits (Black,Blue,Green,Red): ${orderedBits.join('')}\n` +
        `Reversed: ${binStr} = ${decimal}\n` +
        `Decoded: ${decodedColor}`
      );
    }

    function showToast(message) {
      toast.textContent = message;
      toast.classList.add('show');
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => toast.classList.remove('show'), 3200);
    }

    // Determine the next color to show after each tap
    function nextColorForTap(idx) {
      if (idx <= 3) return getRandomColor(["Purple", ...INPUT_ORDER]);                    // warm-up
      if (idx === 4) return "Purple";                                                    // cue
      if (idx >= 5 && idx <= 8) return INPUT_ORDER[idx - 5];                             // inputs
      if (idx === 9) return getRandomColor(["Pink", ...INPUT_ORDER, decodedColor, previousColor]); // spacer
      if (idx === 10) return decodedColor || "Pink";                                     // reveal
      return getRandomColor([]);                                                         // free play
    }

    function maybeRecordBitForCurrentColor(bit) {
      // Record once per input color screen (by COLOR, not tap count)
      if (INPUT_SET.has(currentColor) && bitsByColor[currentColor] === null) {
        bitsByColor[currentColor] = bit;
        if (allBitsCaptured()) computeDecode();
      }
    }

    function handleTap(side) {
      const bit = side === 'right' ? 1 : 0; // Right=1, Left=0

      // 1) Record based on current screen color
      maybeRecordBitForCurrentColor(bit);

      // 2) Advance routine
      tapIndex += 1;
      const next = nextColorForTap(tapIndex);
      showColor(next);

      // 3) Safety: entering reveal without computed decode
      if (tapIndex === 9 && !decodedColor) {
        if (allBitsCaptured()) {
          computeDecode();
        } else {
          decodedColor = "Pink";
          decodedDecimal = null;
          showToast("Missing bit(s). Showing Pink as warning.");
        }
      }
    }

    // ---------- Start ----------
    startBtn.addEventListener('click', () => {
      startBtn.style.display = 'none';
      reset();
    });

    // Unified pointer/touch/mouse handler on the whole app
    const unifiedHandler = (ev) => {
      if (startBtn.style.display !== 'none') return; // not started

      let x = null;
      if (ev.type.startsWith('touch')) {
        const t = ev.touches && ev.touches[0];
        if (!t) return;
        x = t.clientX;
      } else if (ev.type === 'pointerdown' || ev.type === 'mousedown') {
        x = ev.clientX;
      } else {
        return;
      }

      const rect = app.getBoundingClientRect();
      const isLeft = (x - rect.left) < rect.width / 2;
      handleTap(isLeft ? 'left' : 'right');
      ev.preventDefault();
    };

    if (window.PointerEvent) {
      app.addEventListener('pointerdown', unifiedHandler, { passive: false });
    } else {
      app.addEventListener('touchstart', unifiedHandler, { passive: false });
      app.addEventListener('mousedown', unifiedHandler);
    }
  </script>
</body>
</html>
